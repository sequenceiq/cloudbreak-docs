<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        
        <link rel="canonical" href="http://sequenceiq.com/cloudbreak-docs/ldap/">
        <link rel="shortcut icon" href="../img/favicon.ico">

	<title>LDAP/AD (TP) - Cloudbreak 1.6.2</title>

        <link href="../css/bootstrap-custom.min.css" rel="stylesheet">
        <link href="../css/font-awesome-4.0.3.css" rel="stylesheet">
        <link href="../css/base.css" rel="stylesheet">
        <link rel="stylesheet" href="../css/highlight.css">

        <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
        <!--[if lt IE 9]>
            <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
            <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
        <![endif]-->

        
    </head>

    <body>

        <div class="navbar navbar-default navbar-fixed-top" role="navigation" background="red">
    <div class="container">

        <!-- Collapsed navigation -->
        <div class="navbar-header">
            
            <!-- Expander button -->
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            

            <!-- Main title -->
            <img class="navbar-logo" src="../img/HWX-RGB-full-no-tagline_500pxh.png" alt="Hortonworks Documentation"
                 width="132" height="52">
            <a class="navbar-brand" href="..">Cloudbreak 1.6.2</a>
        </div>

        <!-- Expanded navigation -->
        <div class="navbar-collapse collapse">
            
                <!-- Main navigation -->
                <ul class="nav navbar-nav">
                
                
                    <li class="dropdown">
                        <a href="#" class="dropdown-toggle" data-toggle="dropdown">Home <b class="caret"></b></a>
                        <ul class="dropdown-menu">
                        
                            
<li >
    <a href="..">Introduction</a>
</li>

                        
                            
<li >
    <a href="../architecture/">Architecture</a>
</li>

                        
                            
<li >
    <a href="../onprem/">Installation</a>
</li>

                        
                            
<li >
    <a href="../releasenotes/">Release Notes</a>
</li>

                        
                            
<li >
    <a href="../issues/">Known Issues</a>
</li>

                        
                            
<li >
    <a href="../changelog/">Change Log</a>
</li>

                        
                        </ul>
                    </li>
                
                
                
                    <li >
                        <a href="../aws/">AWS</a>
                    </li>
                
                
                
                    <li >
                        <a href="../azure/">Azure</a>
                    </li>
                
                
                
                    <li >
                        <a href="../gcp/">GCP</a>
                    </li>
                
                
                
                    <li >
                        <a href="../openstack/">OpenStack</a>
                    </li>
                
                
                
                    <li class="dropdown active">
                        <a href="#" class="dropdown-toggle" data-toggle="dropdown">Reference <b class="caret"></b></a>
                        <ul class="dropdown-menu">
                        
                            
<li >
    <a href="../api/">API</a>
</li>

                        
                            
<li >
    <a href="../shell/">CLI/Shell</a>
</li>

                        
                            
<li >
    <a href="../update/">Update Cloudbreak</a>
</li>

                        
                            
<li >
    <a href="../ui_account/">Account Management</a>
</li>

                        
                            
<li >
    <a href="../periscope/">Auto-Scaling</a>
</li>

                        
                            
<li >
    <a href="../recipes/">Recipes</a>
</li>

                        
                            
<li >
    <a href="../blueprints/">Blueprints</a>
</li>

                        
                            
<li >
    <a href="../images/">Cloud Images (TP)</a>
</li>

                        
                            
<li >
    <a href="../database/">Ambari Database (TP)</a>
</li>

                        
                            
<li >
    <a href="../topologies/">Platforms (TP)</a>
</li>

                        
                            
<li >
    <a href="../kerberos/">Kerberos (TP)</a>
</li>

                        
                            
<li class="active">
    <a href="./">LDAP/AD (TP)</a>
</li>

                        
                            
<li >
    <a href="../mesos/">Mesos (TP)</a>
</li>

                        
                            
<li >
    <a href="../spi/">SPI</a>
</li>

                        
                            
<li >
    <a href="../operations/">Basic Operations</a>
</li>

                        
                            
<li >
    <a href="../configuration/">Advanced Configuration</a>
</li>

                        
                            
  <li class="dropdown-submenu">
    <a tabindex="-1" href="">Development</a>
    <ul class="dropdown-menu">
        
            
<li >
    <a href="../flow/">Flows</a>
</li>

        
    </ul>
  </li>

                        
                        </ul>
                    </li>
                
                
                </ul>
            

            <ul class="nav navbar-nav navbar-right">
                <li class="dropdown">
                    <a href="#" class="dropdown-toggle" data-toggle="dropdown">Versions <b class="caret"></b></a>
                    <ul class="dropdown-menu" id="versions-dropdown">
                    </ul>
                </li>
                
                <li>
                    <a href="#" data-toggle="modal" data-target="#mkdocs_search_modal">
                        <i class="fa fa-search"></i> Search
                    </a>
                </li>
                
                    <li >
                        <a rel="next" href="../kerberos/">
                            <i class="fa fa-arrow-left"></i> Previous
                        </a>
                    </li>
                    <li >
                        <a rel="prev" href="../mesos/">
                            Next <i class="fa fa-arrow-right"></i>
                        </a>
                    </li>
                
                
                    <li>
                        <a href="https://github.com/sequenceiq/cloudbreak-docs/blob/master/docs/" >
                            
                                <i class="fa fa-github"></i>
                            
                            GitHub
                        </a>
                    </li>
                
            </ul>
        </div>
    </div>
</div>

        <div class="container">
            
                <div class="col-md-3"><div class="bs-sidebar hidden-print affix well" role="complementary">
    <ul class="nav bs-sidenav">
    
        <li class="main active"><a href="#ldapad-configuration">LDAP/AD configuration</a></li>
        
            <li><a href="#mapping-oauth2-scopes-to-ldap-groups">Mapping Oauth2 scopes to LDAP groups</a></li>
        
    
    </ul>
</div></div>
                <div class="col-md-9" role="main">
                    

<h1 id="ldapad-configuration">LDAP/AD configuration</h1>
<p>There are cases where it might be useful to authenticate Cloudbreak users against an existing enterprise LDAP/AD server as it might already have all the users preconfigured. Cloudbreak supports this without the need to modify the existing LDAP schema.</p>
<p>To setup LDAP/AD authentication for Cloudbreak, the <code>/var/lib/cloudbreak-deployment/uaa.yml</code> must be changed as it is described in <a href="https://github.com/cloudfoundry/uaa/blob/master/docs/UAA-LDAP.md">Cloudfoundry's documentation</a>.</p>
<p>Sample for LDAP authentication (the CN of the users in LDAP is the e-mail address in this case, as Cloudbreak uses an e-mail address as identifier):</p>
<pre><code>spring_profiles: postgresql,ldap

ldap:
  profile:
    file: ldap/ldap-search-and-bind.xml
  base:
    url: 'ldap://10.0.3.138:389/'
    userDn: 'CN=Administrator,CN=Users,DC=ad,DC=hortonworks,DC=com'
    password: 'Admin123!'
    searchBase: 'DC=ad,DC=hortonworks,DC=com'
    searchFilter: 'cn={0}'
  groups:
    file: ldap/ldap-groups-map-to-scopes.xml
    searchBase: ou=scopes,dc=ad,dc=hortonworks,dc=com
    searchSubtree: true
    groupSearchFilter: member={0}
    maxSearchDepth: 10
    autoAdd: true

... rest of the content of uaa.yml
</code></pre>

<p>An ldapsearch query can be run to verify the Administrator's credentials and to be able to bind (sample):</p>
<pre><code>ldapsearch -x -h 10.0.3.138 -D &quot;CN=Administrator,CN=Users,DC=ad,DC=hortonworks,DC=com&quot; -W -b &quot;uid=user,cn=Users,dc=ad,dc=hortonworks,dc=com&quot;
</code></pre>

<p>If the user cannot bind, then it is possible to use password comparison method as well as described <a href="https://github.com/cloudfoundry/uaa/blob/master/docs/UAA-LDAP.md#selecting-an-authentication-method">here</a>.</p>
<p>Once the changes are made the following property must be set in the Profile file:</p>
<pre><code>CBD_FORCE_START=true
</code></pre>

<p>This will ensure that the application will start with the modified uaa.yml. After that changes are made restart the application:</p>
<pre><code>cbd kill
cbd start
</code></pre>

<p><code>Note:</code> DO NOT use the <code>cbd restart</code> command as it regenerates all the yml files so the changes will be lost in uaa.yml.</p>
<h2 id="mapping-oauth2-scopes-to-ldap-groups">Mapping Oauth2 scopes to LDAP groups</h2>
<p>In order for the users to have access to Cloudbreak resources and to be able to create clusters the Oauth2 scopes must be mapped to LDAP groups. At the moment Cloudbreak only supports <code>one LDAP group per user</code> scenario.
To see the Oauth2 scopes, execute the following command:</p>
<pre><code>docker exec -it cbreak_uaadb_1 psql -U postgres -c 'select displayname from groups;'
</code></pre>

<p>To save them to a <code>groups.txt</code> file:</p>
<pre><code>docker exec cbreak_uaadb_1 psql -U postgres -c 'select displayname from groups;' | tail -n +3 | grep -v rows | xargs -I@ echo @ &gt;&gt; groups.txt
</code></pre>

<p>To generate the SQL commands for the mapping we'll use <a href="https://github.com/gliderlabs/sigil">sigil</a>, which is a string interpolator and template processor. It is a single binary written in Golang and you can download it from the <a href="https://github.com/gliderlabs/sigil/releases">releases</a> page.
Save the following in a file called: <code>template.sig</code> (cn=admin,ou=scopes,dc=ad,dc=hortonworks,dc=com depends on your LDAP group, it must be inside searchBase parameter configured in the first step in UAA.yml):</p>
<pre><code>{{ range $k, $v := stdin|split &quot;\n&quot;}}
 INSERT INTO external_group_mapping (group_id, external_group, added, origin) VALUES ((select id from groups where displayname='{{$v}}'), 'cn=admin,ou=scopes,dc=ad,dc=hortonworks,dc=com', '2016-09-30 19:28:24.255', 'ldap');{{end}}
</code></pre>

<p>then generate the SQL commands into <code>mapping.sql</code>:</p>
<pre><code>cat groups.txt | sigil -f template.sig &gt; mapping.sql
</code></pre>

<p>and remove lines with empty displayname:</p>
<pre><code>sed -i.bak &quot;/displayname=''/d&quot; mapping.sql
</code></pre>

<p>then execute the commands:</p>
<pre><code>docker cp mapping.sql cbreak_uaadb_1:/tmp/mapping.sql
docker exec cbreak_uaadb_1 psql -U postgres -f /tmp/mapping.sql
</code></pre>

<p>After the mapping is successfully done, you can log in with users authenticated against LDAP.
If a user is a member of multiple LDAP groups, then an error message is presented during Cloudbreak login.  </p>
                    <a href="https://github.com/sequenceiq/cloudbreak-docs/blob/master/docs/ldap.md" ><i class="fa fa-github"></i> Edit on GitHub </a>
                </div>
            
        </div>

        <footer class="col-md-12">
            <hr>
            
            <center>Documentation built with <a href="https://gliderlabs.com/pagebuilder">Pagebuilder</a>.</center>
        </footer>

        <script src="../js/jquery-1.10.2.min.js"></script>
        <script src="../js/bootstrap-3.0.3.min.js"></script>
        <script src="../js/highlight.pack.js"></script>
        <script>var base_url = '..';</script>
        <script data-main="../mkdocs/js/search.js" src="../mkdocs/js/require.js"></script>
        <script src="../js/base.js"></script>

        <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="Search Modal" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                        <h4 class="modal-title" id="exampleModalLabel">Search</h4>
                    </div>
                    <div class="modal-body">
                        <p>
                            From here you can search these documents. Enter
                            your search terms below.
                        </p>
                        <form role="form">
                            <div class="form-group">
                                <input type="text" class="form-control" placeholder="Search..." id="mkdocs-search-query">
                            </div>
                        </form>
                        <div id="mkdocs-search-results"></div>
                    </div>
                    <div class="modal-footer">
                    </div>
                </div>
            </div>
        </div>

         <script>
           $( document ).ready(function() {
               $.getJSON("http://sequenceiq.com/cloudbreak-docs/versions.json", function(data) {
               $("#versions-dropdown").append('<li><a href="http://sequenceiq.com/cloudbreak-docs/latest">latest ('+data.latest+')</a></li>');
                $.each(data.versions, function( index, value ) {
                  $("#versions-dropdown").append('<li><a href="http://sequenceiq.com/cloudbreak-docs/'+value+'">'+value+'</a></li>');
                });
               });

               <!--AWS Table-->
               $.getJSON("../providers/aws.json", function(data) {
               $("#cloudbreak-deployer-aws-image-details").append('<br>');
               $("#cloudbreak-deployer-aws-image-details").append('<br>');
               $("#cloudbreak-deployer-aws-image-details").append('<table>');
                 $("#cloudbreak-deployer-aws-image-details").append('<col width="290">');
                 $("#cloudbreak-deployer-aws-image-details").append('<col width="290">');
                 $("#cloudbreak-deployer-aws-image-details").append('<thead>');
                  $("#cloudbreak-deployer-aws-image-details").append('<tr>');
                   $("#cloudbreak-deployer-aws-image-details").append('<th halign="center" style="font-size: 14pt;border:none;border-bottom:solid #DDDDDD 1.5pt;padding:6.0pt 6.0pt 6.0pt 6.0pt">' + "Region" + '</th>');
                   $("#cloudbreak-deployer-aws-image-details").append('<th halign="center" style="font-size: 14pt;border:none;border-bottom:solid #DDDDDD 1.5pt;padding:6.0pt 6.0pt 6.0pt 6.0pt">' + "Image Name" + '</th>');
                  $("#cloudbreak-deployer-aws-image-details").append('</tr>');
                 $("#cloudbreak-deployer-aws-image-details").append('</thead>');
                $("#cloudbreak-deployer-aws-image-details").append('<tbody>');
                 $.each(data.metadata, function( index, value ) {
                 if (index.indexOf("region.") === 0) {
                   shortIndex = index.substring(7)
                  $("#cloudbreak-deployer-aws-image-details").append('<tr>');
                   $("#cloudbreak-deployer-aws-image-details").append('<td halign="center" valign="center" text-align="left" style="font-size: 12pt;border:none;border-bottom:solid #DDDDDD 1.5pt;padding:6.0pt 6.0pt 6.0pt 6.0pt">' + shortIndex + '</td>');
                   $("#cloudbreak-deployer-aws-image-details").append('<td halign="center" valign="center" text-align="right" style="font-size: 12pt;border:none;border-bottom:solid #DDDDDD 1.5pt;padding:6.0pt 6.0pt 6.0pt 6.0pt">' + value + '</td>');
                  $("#cloudbreak-deployer-aws-image-details").append('</tr>');
                  }
                 });
                $("#cloudbreak-deployer-aws-image-details").append('</tbody>');
               $("#cloudbreak-deployer-aws-image-details").append('</table>');
               });

               <!--OpenStack CBD-->
               $.getJSON("../providers/openstack.json", function(data) {
               $("#cloudbreak-deployer-image").append('<br>');
               $("#cloudbreak-deployer-image").append('<br>');
               $("#cloudbreak-deployer-image").append('<p style="font-size: 14px;font-family: "Helvetica Neue", Helvetica, Arial, sans-serif;line-height: 1.428571429;color: #555;">Download the latest Cloudbreak Deployer image to your local machine:</p>');
               $("#cloudbreak-deployer-image").append('<pre><code style="font-size: 12pt;color:#333333">curl -O https://public-repo-1.hortonworks.com/HDP/cloudbreak/' + data.metadata.image_name + '.img</code></pre>');
               $("#cloudbreak-deployer-import").append('<br>');
               $("#cloudbreak-deployer-import").append('<br>');
               $("#cloudbreak-deployer-import").append('<p style="font-size: 14px;font-family: "Helvetica Neue", Helvetica, Arial, sans-serif;line-height: 1.428571429;color: #555;">Set the following environment variables for the OpenStack image import:</p>');
               $("#cloudbreak-deployer-import").append('<pre><code style="font-size: 12px;color:#333333">export CBD_LATEST_IMAGE=</code>' + data.metadata.image_name + '.img</code></p>');
               });

               <!--OpenStack CB-->
               $.getJSON("../providers/openstack_cloudbreak.json", function(data) {
               $("#cloudbreak-image").append('<br>');
               $("#cloudbreak-image").append('<br>');
               $("#cloudbreak-image").append('<p style="font-size: 14px;font-family: "Helvetica Neue", Helvetica, Arial, sans-serif;line-height: 1.428571429;color: #555;">Download the latest Cloudbreak image to your local machine:</p>');
               $("#cloudbreak-image").append('<pre><code style="font-size: 12pt;color:#333333">curl -O https://public-repo-1.hortonworks.com/HDP/cloudbreak/' + data.metadata.image_name + '.img</code></pre>');
               $("#cloudbreak-import").append('<br>');
               $("#cloudbreak-import").append('<br>');
               $("#cloudbreak-import").append('<p style="font-size: 14px;font-family: "Helvetica Neue", Helvetica, Arial, sans-serif;line-height: 1.428571429;color: #555;">This is very similar to the Cloudbreak Deployer. Set the following environment variables for the OpenStack image import:</p>');
               $("#cloudbreak-import").append('<pre><code style="font-size: 12px;color:#333333">export CB_LATEST_IMAGE=</code>' + data.metadata.image_name + '.img</code></p>');
               });

               <!--GCP-->
               $.getJSON("../providers/gcp.json", function(data) {
               $("#cloudbreak-deployer-gcp-image-details").append('<br>');
               $("#cloudbreak-deployer-gcp-image-details").append('<br>');
               $("#cloudbreak-deployer-gcp-image-details").append('<pre><code style="font-size: 12pt;color:#333333"> gcloud compute images create '
                   + data.id + ' --source-uri gs://sequenceiqimage/' + data.id + '.tar.gz' + '</code></pre>');
               });
           });
         </script>
    </body>
</html>
